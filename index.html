<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CBCL</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}
  .legend{background:#0b1220;border:1px dashed var(--line);border-radius:10px;padding:10px;margin:6px 0 12px}
  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220}
  .q h3{margin:0 0 8px;font-size:1rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>CBCL</h1>
    <p class="muted">Considere seu(ua) filho(a) <b>agora e nos últimos 6 meses</b>. Marque: <strong>Nunca, Às vezes, Frequentemente. </strong></p>
    <div class="legend muted">Nunca &nbsp;•&nbsp; Às vezes &nbsp;•&nbsp; Frequentemente</div>

    <!-- Dados do paciente (por token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_CBCL" };
const CODE = "CBCL";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return;
  el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block";
}
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function POST(url, body){ const r=await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function PATCH(url, body){ const r=await fetch(url,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] }); }
async function sheetPatchBy(sheet, column, value, data){ return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data }); }
function goPortalWithToken(){ const TOKEN=qs("token"); try{ const u=new URL(PORTAL_URL,location.href); u.searchParams.set("token",TOKEN); location.href=u.toString(); }catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN); }}

// ======== ITENS (somente perguntas; sem campos de texto) ========
const ITEMS = {
  1:"Comporta-se de modo infantil, como se tivesse menos idade.",
  3:"Argumenta muito.",
  7:"É convencido, gaba-se de si mesmo.",
  8:"É distraído; atenção curta.",
  9:"Não consegue tirar certos pensamentos da cabeça (obsessões).",
  10:"É agitado; não para quieto.",
  11:"Fica grudado nos adultos; muito dependente.",
  12:"Queixa-se de solidão.",
  13:"Parece confuso/atordoado.",
  14:"Chora muito.",
  16:"É cruel; maltrata as pessoas.",
  17:"Fica no “mundo da lua”.",
  19:"Exige que prestem atenção nele(a).",
  20:"Destrói as próprias coisas.",
  21:"Destrói coisas de outras pessoas.",
  22:"Desobediente em casa.",
  23:"Desobediente na escola.",
  24:"Dificuldade para comer.",
  25:"Não se dá bem com outras crianças/adolescentes.",
  26:"Não se arrepende depois de se comportar mal.",
  27:"Fica com ciúmes facilmente.",
  31:"Medo de cometer ato destrutivo.",
  32:"Perfeccionista.",
  33:"Acha que ninguém gosta dele(a).",
  34:"Acha que os outros o perseguem.",
  35:"Sente-se desvalorizado(a)/inferior.",
  36:"Machuca-se com frequência; tendência a acidentes.",
  37:"Entra em muitas brigas.",
  39:"Mexe nas partes íntimas em público.",
  40:"Escuta sons/vozes que não existem.",
  41:"Impulsivo; age sem pensar.",
  42:"Prefere ficar sozinho(a) do que acompanhado(a).",
  43:"Mente/engana.",
  45:"Nervoso(a), tenso(a).",
  46:"Tiques nervosos.",
  48:"As outras crianças não gostam dele(a).",
  50:"Ansioso(a) demais.",
  51:"Tonturas.",
  52:"Culpa-se em excesso.",
  54:"Cansaço excessivo.",
  55:"Está acima do peso.",
  "56a":"Queixas físicas: dores (outras).",
  "56b":"Queixas físicas: dores de cabeça.",
  "56c":"Queixas físicas: náuseas/enjoos.",
  "56d":"Queixas físicas: problemas com os olhos.",
  "56e":"Queixas físicas: problemas de pele.",
  "56f":"Queixas físicas: dores de estômago/barriga.",
  "56g":"Queixas físicas: vômitos.",
  57:"Ataca fisicamente as pessoas.",
  61:"Não vai bem na escola.",
  62:"Desastrado/desajeitado.",
  63:"Prefere brincar com mais velhos.",
  65:"Recusa-se a falar.",
  66:"Repete atos várias vezes (compulsões).",
  67:"Foge de casa.",
  68:"Grita muito.",
  69:"Reservado; guarda as coisas para si.",
  70:"Vê coisas que não existem.",
  71:"Sem jeito diante dos outros; preocupado com o que pensam.",
  72:"Põe fogo nas coisas.",
  74:"Se mostra/faz palhaçadas para chamar atenção.",
  75:"Tímido(a)/envergonhado(a).",
  80:"Olhar fixo e vazio.",
  81:"Rouba em casa.",
  82:"Rouba fora de casa.",
  84:"Comportamento estranho.",
  85:"Ideias estranhas.",
  86:"Mal-humorado/irritável.",
  87:"Mudanças repentinas de humor.",
  88:"Amua/emburra.",
  89:"Desconfiado(a).",
  90:"Urina.",
  93:"Fala demais.",
  94:"Gosta de “gozar” dos outros.",
  95:"Esquentado(a); acessos de raiva.",
  96:"Pensa demais em sexo.",
  97:"Ameaça pessoas.",
  101:"Cabula as aulas.",
  102:"Pouco ativo; vagaroso; falta energia.",
  103:"Infeliz, triste ou deprimido(a).",
  104:"Barulhento(a) demais.",
  105:"Uso de álcool/drogas.",
  106:"Vandalismo (estraga bens públicos).",
  111:"Retraído(a); não se relaciona.",
  112:"Muito preocupado(a).",
  64:"Evita situações sociais."  /* adicionado para cobrir a síndrome de contato social */
};

// ======== SÍNDROMES (segundo sua lista) ========
const SYND = {
  retraimento:        ["42","65","69","75","80","88","102","103","111"],
  queixas_somaticas:  ["51","54","56a","56b","56c","56d","56e","56f","56g"],
  ansiedade_dep:      ["12","14","31","32","33","34","35","45","50","52","71","89","103","112"],
  contato_social:     ["1","11","25","36","48","55","62","64"],
  pensamento:         ["9","40","66","70","80","84","85"],
  atencao:            ["1","8","10","13","17","41","45","46","61","62","80"],
  delinquente:        ["26","39","43","63","67","72","81","82","90","96","101","105","106"],
  agressivo:          ["3","7","16","19","20","21","22","23","27","37","57","68","74","86","87","93","94","95","97","104"]
};

// ======== OPÇÕES ========
const CHOICES = [
  {label:"Nunca", value:0},
  {label:"Às vezes", value:1},
  {label:"Frequentemente", value:2},
];

// ======== UI ========
function uniqueItemIds(){
  const s=new Set();
  Object.values(SYND).flat().forEach(id=>s.add(String(id)));
  return Array.from(s).sort((a,b)=>{
    const na=parseInt(a), nb=parseInt(b);
    if(na!==nb) return na-nb;
    return a.localeCompare(b);
  });
}

function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  const ids=uniqueItemIds();

  let prog=document.getElementById("progress");
  if(!prog){
    prog=document.createElement("div");
    prog.id="progress";
    prog.className="muted";
    prog.style.margin="0 0 10px";
    prog.textContent=`0/${ids.length} respondidas`;
    $("#form").insertBefore(prog, host);
  }

  ids.forEach((id)=>{
    const qn=id.replace(/\s+/g,'');
    const wrap=document.createElement("div"); wrap.className="q"; wrap.setAttribute("role","group"); wrap.setAttribute("aria-labelledby",`lbl${qn}`);
    const label=ITEMS[id] || `Item ${id}`;
    wrap.innerHTML=`<h3 id="lbl${qn}">${id}. ${label}</h3>`;
    const opts=document.createElement("div"); opts.className="opts";
    CHOICES.forEach(c=>{
      const htmlId=`q${qn}_${c.value}`;
      const lab=document.createElement("label"); lab.className="opt";
      lab.innerHTML=`<input type="radio" name="q${qn}" id="${htmlId}" value="${c.value}" required><span>${c.label}</span>`;
      opts.appendChild(lab);
    });
    wrap.appendChild(opts); host.appendChild(wrap);
  });

  host.addEventListener("change", ()=>{
    const answered=document.querySelectorAll('#qs input[type="radio"]:checked').length;
    $("#progress").textContent=`${answered}/${ids.length} respondidas`;
    autosaveAnswers();
  });
}

// ======== AUTOSAVE ========
function autosaveAnswers(){
  const ids=uniqueItemIds();
  const answers={};
  ids.forEach(id=>{
    const qn=id.replace(/\s+/g,'');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) answers[id]=Number(sel.value);
  });
  localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({code:CODE, token:qs("token"), answers}));
}
function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY); if(!raw) return;
    const {answers}=JSON.parse(raw)||{}; if(!answers) return;
    Object.entries(answers).forEach(([id,val])=>{
      const qn=id.replace(/\s+/g,'');
      const el=document.querySelector(`input[name="q${qn}"][value="${val}"]`);
      if(el) el.checked=true;
    });
    const answered=Object.keys(answers).length;
    $("#progress").textContent=`${answered}/${uniqueItemIds().length} respondidas`;
  }catch(_){}
}
function clearAutosave(){ localStorage.removeItem(AUTOSAVE_KEY); }

// ======== ESTADO ========
let patient=null, tokenRow=null, CPF=""; let startAt=Date.now();

// ======== BOOT POR TOKEN ========
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    // 1) token
    const trows=await sheetSearch(SHEETS.TOKENS,{ token:TOKEN });
    if(!trows?.length) throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Peça um novo link.");

    // 2) paciente
    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");
    const prows=await sheetSearch(SHEETS.PATIENTS,{ cpf:CPF });
    if(!prows?.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    // 3) liberação por coluna CODE = "sim"
    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){ setBox("#alert","Este formulário não está liberado para você. Entre em contato com o consultório.","err"); return; }

    // 4) anti-duplicidade
    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo(); renderQuestions();
    $("#pacInfo").style.display="grid"; $("#form").style.display="block"; hideBox("#alert");
    startAt=Date.now(); restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["CPF",maskCPF(patient.cpf)],["Nascimento",fmtDateISO(patient.data_nascimento)],["E-mail",patient.email||"-"],["WhatsApp",patient.whatsapp||"-"]];
  for(const [k,v] of info){ const d=document.createElement("div"); d.className="info"; d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`; g.appendChild(d); }
}

// ======== CATEGORIA STRING (como você pediu) ========
function buildCategoriaFromSums(s){
  // ordem + rótulos exatamente como solicitou
  const order = [
    ["retraimento",       "Retraimento"],
    ["queixas_somaticas", "Queixas Somáticas"],
    ["ansiedade_dep",     "Ansiedade Depressão"],
    ["contato_social",    "Problemas com contato Social"],
    ["pensamento",        "Problemas de Pensamento"],
    ["atencao",           "Problemas com atencao"],
    ["delinquente",       "Comportamento delinquente"],
    ["agressivo",         "Comportamento agressivo"]
  ];
  return order.map(([key,label]) => `${label}: ${s[key] ?? 0}`).join(" | ");
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const originalText=btn.textContent; btn.disabled=true; btn.textContent="Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // 1) coletar respostas
    const ids=uniqueItemIds();
    const answers={}; let firstMissing=null;
    ids.forEach(id=>{
      const qn=id.replace(/\s+/g,'');
      const sel=document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel && firstMissing===null) firstMissing=id;
      if(sel) answers[id]=Number(sel.value);
    });
    if(firstMissing!==null){
      setBox("#msg", `Responda o item ${firstMissing}.`, "warn");
      document.getElementById(`lbl${String(firstMissing).replace(/\s+/g,'')}`)?.scrollIntoView({behavior:"smooth", block:"center"});
      sending=false; btn.disabled=false; btn.textContent=originalText; return;
    }

    // 2) checagem duplicidade
    const again=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000); return;
    }

    // 3) somas por síndrome
    const sums = {};
    Object.entries(SYND).forEach(([key, list])=>{
      sums[key] = list.reduce((acc,id)=> acc + (answers[id]!=null ? answers[id] : 0), 0);
    });

    // 4) total (soma dos itens únicos)
    const total = Object.values(answers).reduce((a,b)=>a+b,0);
    const durationSec = Math.round((Date.now()-startAt)/1000);

    // 5) string de categoria com todas as somas
    const categoriaStr = buildCategoriaFromSums(sums);

    // 6) salvar
    const row = {
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),
      cpf:patient.cpf,
      code:CODE,
      source:"responsável",
      submitted_at:new Date().toISOString(),
      total,
      categoria: categoriaStr, // <-- vai completo para a coluna categoria
      metrics: JSON.stringify({ answers, sums, duration_sec: durationSec })
    };
    await sheetCreate(SHEETS.SCORES,row);

    // 7) marcar como feito
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{ [`${CODE}_FEITO`]:"sim", [`${CODE}_FEITO_AT`]:new Date().toISOString() });

    clearAutosave();
    setBox("#msg","Formulário enviado. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken, 1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=originalText;
  }
});
</script>
</body>
</html>
